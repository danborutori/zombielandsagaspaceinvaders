"use strict";var zlsSpaceInvader;!function(t){class e{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new e(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}set(t,e){return this.x=t,this.y=e,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}add(t,e){return"number"==typeof t?(this.x+=t,this.y+=t):e?(this.x=t.x+e.x,this.y=t.y+e.y):(this.x+=t.x,this.y+=t.y),this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return e?(this.x=t.x-e.x,this.y=t.y-e.y):(this.x-=t.x,this.y-=t.y),this}multiply(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}abs(){this.x=Math.abs(this.x),this.y=Math.abs(this.y)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return 0!=t&&this.multiply(1/t),this}dot(t){return this.x*t.x+this.y*t.y}angle(t){if(void 0===t){return Math.atan2(-this.y,-this.x)+Math.PI}return this.angle()-t.angle()}random(){return this.x=Math.random(),this.y=Math.random(),this}rotateAround(t){const e=Math.cos(t),s=Math.sin(t),i=this.x,a=this.y;return this.x=i*e-a*s,this.y=i*s+a*e,this}apply(t){return this.rotateAround(t.rotation).add(t.translation)}}t.Vector2=e;const s=new e(0,0);t.Transform=class{constructor(t=0,i=s){this.rotation=t,this.translation=new e,this.translation.copy(i)}multiply(t){return this.rotation+=t.rotation,this.translation.rotateAround(t.rotation).add(t.translation),this}copy(t){this.rotation=t.rotation,this.translation.copy(t.translation)}},t.mix=function(t,e,s){return t*(1-s)+e*s}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=new t.Vector2,a=new t.Vector2,o=new t.Vector2,r=new t.Vector2,n=new t.Vector2,h=new t.Vector2,l=new t.Vector2,c=.01;class d{}t.ColliderShape=d;t.ColliderBox=class extends d{constructor(e){super(),this.isColliderBox=!0,this.size=new t.Vector2,this.size.copy(e)}};t.ColliderLineSegment=class extends d{constructor(){super(...arguments),this.isColliderLineSegment=!0,this.from=new t.Vector2,this.to=new t.Vector2}};function p(t,e,s){return h.sub(t,s).abs(),h.x<=e.size.x+c&&h.y<=e.size.y+c}function m(t,e,s){h.sub(s,e).sub(t.from),l.sub(t.to,t.from).normalize();const i=h.dot(l);return i>=0&&i<=t.to.distance(t.from)}function g(t,h,l,c,d){if(p(e.add(t.to,h),l,c)&&p(e.add(t.from,h),l,c))return d.add(t.to,t.from).multiply(.5),!0;const g=e.sub(t.to,t.from).normalize(),u=s.sub(c,h).sub(t.from).addScaled(l.size,.5),w=i.sub(c,h).sub(t.from).addScaled(l.size,-.5),f=[a.copy(g).multiply(w.x/g.x).add(h).add(t.from),o.copy(g).multiply(u.x/g.x).add(h).add(t.from),r.copy(g).multiply(w.y/g.y).add(h).add(t.from),n.copy(g).multiply(u.y/g.y).add(h).add(t.from)];for(let e of f)if(p(e,l,c)&&m(t,h,e))return d.copy(e),!0;return!1}t.ColliderCompoundShape=class extends d{constructor(){super(...arguments),this.isCompoundShape=!0,this.shapes=[]}};class u{static intersect(i,a,o,r,n){const h=i,l=o;if(h.isColliderBox&&l.isColliderBox)return e.sub(a,r).abs(),s.add(h.size,l.size),n.add(a,r).multiply(.5),e.x<s.x/2&&e.y<s.y/2;const c=o;if(h.isColliderBox&&c.isColliderLineSegment)return g(c,r,h,a,n);const d=i;if(d.isColliderLineSegment&&l.isColliderBox)return g(d,a,l,r,n);const p=i;if(p.isCompoundShape){const e=new t.Vector2;for(let t of p.shapes)if(u.intersect(t.shape,e.add(a,t.pos),o,r,n))return!0;return!1}const m=o;if(m.isCompoundShape){const e=new t.Vector2;for(let t of m.shapes)if(u.intersect(i,a,t.shape,e.add(r,t.pos),n))return!0;return!1}return!1}}t.CollisionChecker=u}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{constructor(){this.pos=new t.Vector2,this.paused=!1,this.renderHalf=!0,this.renderOrder=0,this.visible=!0,this.waitPromises=[]}update(t){for(let e of Array.from(this.waitPromises).sort((t,e)=>t.priority-e.priority))"running"==e.state&&(e.time-=t,e.time<=0&&(e.state="resolved",e.resolve(-e.time)));this.waitPromises=this.waitPromises.filter(t=>"running"==t.state)}render(t,e){}removeFromManager(){const t=this.manager;t&&t.remove(this),this.terminateAllWaiting(new Error("Object removed."))}wait(t,e=0,s){return this.manager?new Promise((i,a)=>{this.waitPromises.push({label:s,time:t,priority:e,resolve:i,reject:a,state:"running"})}):Promise.reject(new Error("Manager is undefined"))}terminateAllWaiting(t=new Error("Terminated")){const e=Array.from(this.waitPromises);this.waitPromises.length=0;for(let s of e)"running"==s.state&&(s.state="rejected",s.reject(t))}}t.GameObject=e;class s extends e{constructor(e){super(),this.sprite=e,this.pos=new t.Vector2}render(t,e){super.render(t,e),e.drawImage(this.sprite,Math.floor(this.pos.x-this.sprite.width/2),Math.floor(this.pos.y-this.sprite.height/2))}}t.SpriteObject=s;t.AnimatedSpriteObject=class extends s{constructor(t,e,s){super(t[0]),this.sprites=t,this.secondPerSprite=e,this.duration=s,this.time=0}get frame(){return Math.floor(this.time/this.secondPerSprite)}update(t){super.update(t),this.time+=t;const e=this.frame;e<this.sprites.length?this.sprite=this.sprites[e]:void 0===this.duration&&this.removeFromManager(),void 0!==this.duration&&this.time>=this.duration&&this.removeFromManager()}};t.GameObjectManager=class{constructor(){this.gameObjects=[],this.playerBullets=new Set,this.playerFlights=new Set,this.enemyFlights=new Set}add(t){t.removeFromManager(),this.gameObjects.push(t),t.manager=this,t.isPlayerBullet?this.playerBullets.add(t):t.isPlayerFlight?this.playerFlights.add(t):t.isEnemyFlight&&this.enemyFlights.add(t)}remove(t){const e=this.gameObjects.indexOf(t);e>=0&&(this.gameObjects.splice(e,1),t.manager=void 0,this.playerBullets.delete(t),this.playerFlights.delete(t),this.enemyFlights.delete(t))}update(t){for(let e of Array.from(this.gameObjects))e.paused||e.update(t)}render(t,e){for(let s of this.gameObjects.filter(t=>!t.renderHalf&&t.visible).sort((t,e)=>t.renderOrder-e.renderOrder))s.render(t,e)}renderHalf(t,e){for(let s of this.gameObjects.filter(t=>t.renderHalf&&t.visible).sort((t,e)=>t.renderOrder-e.renderOrder))s.render(t,e)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=new t.ColliderBox(e.set(9,9));t.EnemyFlight=class extends t.SpriteObject{constructor(e,s,a=100,o){super(e),this.scorer=s,this.score=a,this.hp=o,this.isEnemyFlight=!0,this.flashTime=0,this.vel=new t.Vector2,this.rotateStep=Math.PI/8,this.rotate=0,this.invincible=!1,this.bulletCountDelta=0,this.bulletIntervalScale=1,this.bulletShootAngle=5*Math.PI/180,this.homingTime=2,this.collisionShape=i,this.origSprite=e,this.flashingSprite=t.ColoredSprite.shared.get("white",e)}startFlyOff(e,s,i,a){this.flyOff||(this.flyOff=new t.EnemyFlyOff(this,s,i,a))}get isFlyingOff(){return void 0!==this.flyOff}endFlyOff(){this.flyOff=void 0,this.vel.set(0,0)}wrapAround(){const t=this.scorer.stage.right-this.scorer.stage.left+18,e=this.scorer.stage.bottom-this.scorer.stage.top+18;for(;this.pos.x<this.scorer.stage.left-9;)this.pos.x+=t;for(;this.pos.x>this.scorer.stage.right+9;)this.pos.x-=t;for(;this.pos.y<this.scorer.stage.top-9;)this.pos.y+=e,this.flyOff&&this.flyOff.onWrapY();for(;this.pos.y>this.scorer.stage.bottom+9;)this.pos.y-=e,this.flyOff&&this.flyOff.onWrapY()}update(t){super.update(t),this.pos.addScaled(this.vel,t),this.wrapAround(),this.flashTime-=t,this.flashTime<=0?this.sprite=this.origSprite:Math.floor(this.flashTime/.03)%2==0?this.sprite=this.origSprite:this.sprite=this.flashingSprite,this.collidePlayerBullets(),this.collidePlayerFlight(t)}bulletFactoty(e){return new t.EnemyBullet(this.scorer.stage,e,this)}shoot(s,i){if(this.manager){e.sub(s.pos,this.pos).normalize(),e.rotateAround(Math.cos(i*Math.PI*2)*this.bulletShootAngle);const a=this.bulletFactoty(e);a.pos.copy(this.pos),t.Audio.play(t.Audio.sounds.enemyShooting),this.manager.add(a)}}collidePlayerBullets(){if(this.manager&&!this.invincible){const s=Array.from(this.manager.playerBullets);for(let i of s)i.canHit&&t.CollisionChecker.intersect(this.collisionShape,this.pos,i.collisionShape,i.pos,e)&&(this.flashTime=.1,i.onHitEnemy(e),this.hp>0&&(this.hp-=i.damage,this.hp<=0&&this.onDie()),this.scorer.score+=1)}}resetRotation(t){this.rotate-=Math.sign(this.rotate)*Math.min(Math.abs(this.rotate),t*Math.PI*2)}collidePlayerFlight(i){if(this.manager)for(let a of Array.from(this.manager.playerFlights))if(a&&(this.flyOff?this.flyOff.update(i,a):this.resetRotation(i),a.invincibleTime<=0))for(let i=0;i<a.flightUnits.length;i++){const o=a.flightUnits[i];if(t.CollisionChecker.intersect(this.collisionShape,this.pos,o.collisionShape,e.add(a.pos,o.pos),s)){o.powered?this.hp>0&&(this.hp-=1,this.hp<=0&&this.onDie()):this.onHitPlayer(a,i,this.manager);break}}}onHitPlayer(e,s,i){const a=new t.MemberExplosion;a.pos.add(e.pos,e.flightUnits[s].pos),i.add(a),e.remove(s),t.Audio.play(t.Audio.sounds.explosion)}playExplosionAnimation(){if(this.manager){const e=new t.Explosion;e.pos.copy(this.pos),this.manager.add(e)}}onDie(){this.playExplosionAnimation(),this.removeFromManager(),this.flyOff&&this.flyOff.onDie(),this.scorer.score+=this.score}render(t,e){e.save();const s=Math.floor(this.pos.x),i=Math.floor(this.pos.y);e.translate(s,i),e.rotate(Math.round(this.rotate/this.rotateStep)*this.rotateStep),e.translate(-s,-i),super.render(t,e),e.restore()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=Math.PI,i=36,a=4.5;t.EnemyFlyOff=class{constructor(e,s,i,a){this.enemy=e,this.regroupPos=s,this.shootInterval=i,this.bulletCount=a,this.direction=new t.Vector2(0,-1),this.state="homing",this.time=0,this.shootCooldown=0,this.initBulletCount=a,t.Audio.play(t.Audio.sounds.shipFly)}update(t,o){let r;switch(this.time+=t,this.shootCooldown-=t,this.state){case"homing":r=o.pos,this.shootCooldown<=0&&this.bulletCount>0&&(this.enemy.shoot(o,this.bulletCount/this.initBulletCount),this.shootCooldown+=this.shootInterval,this.bulletCount--);break;case"regroup":r=this.regroupPos;break;case"stop":r=e.set(this.enemy.pos.x,this.enemy.pos.y+100)}if(r){if(e.sub(r,this.enemy.pos),this.time<this.enemy.homingTime||"regroup"===this.state||"stop"===this.state){let i=e.angle(this.direction);i<-Math.PI&&(i+=2*Math.PI);const a=Math.min(Math.abs(i),s*t);this.direction.rotateAround(Math.sign(i)*a),this.enemy.rotate=this.direction.angle()-Math.PI/2}else switch(this.state){case"homing":this.state="goStraight"}switch(this.state){case"regroup":e.sub(this.regroupPos,this.enemy.pos),e.length()<a&&this.enemy.endFlyOff()}}switch(this.state){case"stop":this.enemy.vel.set(0,0);break;default:this.enemy.vel.copy(this.direction).multiply(i)}}onWrapY(){this.state="regroup"}onDie(){}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=new t.Vector2,a=new t.ColliderBox(e.set(1,3));function o(t,i,a,o){const r=e.sub(i,t),n=Math.round(r.length());r.normalize();const h=s.copy(t);for(let t=0;t<n;t++)o.fillRect(Math.floor(h.x-a/2),Math.floor(h.y-a/2),Math.ceil(a),Math.ceil(a)),h.add(r)}t.drawLine=o;class r extends t.GameObject{constructor(e,s){super(),this.stage=e,this.color=s,this.isBullet=!0,this.velocity=new t.Vector2,this.collisionShape=a}offscreenCheck(){(this.pos.y<=this.stage.top||this.pos.y>=this.stage.bottom)&&this.removeFromManager()}update(t){super.update(t),this.pos.addScaled(this.velocity,t),this.offscreenCheck()}render(t,a){super.render(t,a),a.fillStyle=this.color,e.copy(this.velocity).normalize(),o(s.copy(this.pos).floor().addScaled(e,1.5),i.copy(this.pos).floor().addScaled(e,-1.5),1,a)}}t.Bullet=r;class n extends t.AnimatedSpriteObject{constructor(e){super([t.ColoredSprite.shared.get(e,t.Sprites.shared.images.heart0),t.ColoredSprite.shared.get(e,t.Sprites.shared.images.heart1)],.15)}}t.PlayerBullet=class extends r{constructor(e,s){super(e,s),this.isPlayerBullet=!0,this.cancelEnemyBullet=!1,this.damage=1,this.velocity.set(0,-t.Constant.bulletSpeed)}get canHit(){return!0}spark(t){if(this.manager){const e=new n(this.color);e.pos.copy(t||this.pos),this.manager.add(e)}}onHitEnemy(t){this.spark(),this.removeFromManager()}};const h=new t.ColliderBox(e.set(1,1));t.EnemyBullet=class extends r{constructor(e,s,i,a=.5*t.Constant.bulletSpeed){super(e,"white"),this.shooter=i,this.isEnemyBullet=!0,this.canHitPlayer=!0,this.shouldCollidePlayerBullet=(t=>t.cancelEnemyBullet),this.onCollidePlayerBullet=((t,e)=>{this.onHitPlayer(),t.onHitEnemy(e)}),this.velocity.copy(s).multiply(a)}onHitPlayer(){this.removeFromManager()}collidePlayerBullet(){if(this.manager&&this.onCollidePlayerBullet&&this.shouldCollidePlayerBullet)for(let s of this.manager.playerBullets)if(this.shouldCollidePlayerBullet(s)&&t.CollisionChecker.intersect(this.collisionShape,this.pos,s.collisionShape,s.pos,e)){this.onCollidePlayerBullet(s,e);break}}hitPlayer(){if(this.manager&&this.canHitPlayer)for(let i of this.manager.playerFlights){if(i.invincibleTime<=0)for(let a=0;a<i.flightUnits.length;a++){const o=i.flightUnits[a];if(o.powered){if(t.CollisionChecker.intersect(this.collisionShape,this.pos,o.collisionShape,e.add(i.pos,o.pos),s)){this.onHitPlayer();break}}else if(t.CollisionChecker.intersect(this.collisionShape,this.pos,h,e.add(i.pos,o.pos),s)){this.shooter.onHitPlayer(i,a,this.manager),this.onHitPlayer();break}}if(!this.manager)break}}update(t){super.update(t),this.collidePlayerBullet(),this.hitPlayer()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{}e.maxTimeStep=1/15,e.playerMoveSpeed=120,e.playerFireInterval=.16,e.bulletSpeed=120,e.volume=.02,t.Constant=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{constructor(){this.enemies=[]}set pause(t){for(let e of this.enemies)e.paused=t}showTitle(e,s){return new Promise((i,a)=>{const o=new t.WaveScreen(s,i);e.add(o)})}clear(){for(let t of this.enemies)t.removeFromManager()}}t.BaseEnemyWave=e;t.EnemyWave=class extends e{constructor(e,s,i){super(),this.stage=e,this.wave=s,this.onWaveEnd=i,this.isBoss=!1,this.enemyCooperator=new t.EnemyCooperator(s,e,[],()=>{})}set pause(t){super.pause=t,this.enemyCooperator.paused=t}init(e,s,i){const a=[t.Zombie1,t.Zombie2,t.Hand,t.Dog];for(let t=0;t<9;t++)for(let i=0;i<a.length;i++){const o=new a[i](this.enemyCooperator.difficultyProfile.hp,e);o.pos.x=14*(-4.5+t+.5),o.pos.y=14*i-46,s.add(o),this.enemies.push(o)}this.enemyCooperator=new t.EnemyCooperator(this.wave,this.stage,this.enemies,this.onWaveEnd),s.add(this.enemyCooperator),t.missingMembers.length>0&&this.wave%3==2&&this.enemies[4*a.length].setCapture(i,t.missingMembers.splice(0,1)[0],this.enemyCooperator)}clear(){super.clear(),this.enemyCooperator.removeFromManager()}};t.BossEnemyWave=class extends e{constructor(t){super(),this.nextMember=t}async showTitle(e,s){const i=new t.BossTitle;e.add(i),await i.show()}dropPowerUp(e,s){let i=!1;return(async()=>{const a=new t.GameObject;for(s.add(a);;){await a.wait(20);const o=new t.PowerUp(e,this.nextMember);if(o.pos.set(t.mix(e.stage.left+4.5,e.stage.right-4.5,Math.random()),e.stage.top-4.5),s.add(o),i)break}a.removeFromManager()})(),{stop:()=>i=!0}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2;class s extends t.EnemyFlyOff{constructor(t,e,s,i,a){super(e,s,i,a),this.cooperator=t,this.kidnapBeamState="canShot"}update(t,e){switch(super.update(t,e),this.state){case"goStraight":case"homing":switch(this.kidnapBeamState){case"canShot":this.enemy.pos.y>e.pos.y-40&&this.shotBeam(e)}}}async shotBeam(e){if(this.enemy.manager){this.state="stop",this.kidnapBeamState="shootingBeam";const s=new a;s.pos.copy(this.enemy.pos),s.pos.y+=4.5,this.enemy.manager.add(s),t.Audio.play(t.Audio.sounds.captureBeam);try{await this.enemy.wait(1);let t=0,i=!1;for(;t<2&&!i;){t+=await this.enemy.wait(0);let s=4.5+9*e.flightUnits.length/2;Math.abs(e.pos.x-this.enemy.pos.x)<s&&e.invincibleTime<=0&&(i=!0)}i?await this.capture(e,s):(s.state="shorten",await this.enemy.wait(1.5),this.kidnapBeamState="beamEnd",this.state="goStraight")}catch(t){}finally{s.removeFromManager()}}}async capture(e,s){if(this.enemy.manager){this.cooperator.allowFlyOff=!1,this.state="stop",this.cooperator.invincible=!0;const a=new i(e,e.flightUnits,this.enemy,this.cooperator);this.enemy.manager.add(a),this.enemy.kidnapped=a,t.Audio.stop(t.Audio.sounds.captureBeam),t.Audio.play(t.Audio.sounds.captureBeam2),e.invincibleTime=9e3,e.visible=!1,e.paused=!0;try{await this.enemy.wait(1),s.state="shorten",await this.enemy.wait(.5),this.enemy.kidnapped.state="stop",await this.enemy.wait(3),this.kidnapBeamState="beamEnd",this.state="regroup",t.Audio.play(t.Audio.sounds.capturedSuccess);const i=new t.FloatingText("MEMBER CAPTURED");this.enemy.manager.add(i),await this.enemy.wait(3)}catch(t){throw t}finally{e.invincibleTime=0,e.paused=!1,e.flightUnits.length=0,e.next=!0,await this.enemy.wait(2),this.cooperator.allowFlyOff=!0,this.cooperator.invincible=!1}}}}class i extends t.GameObject{constructor(t,e,s,i){super(),this.player=t,this.enemy=s,this.cooperator=i,this.rotate=0,this.state="rotating",this.spacing=9,this.units=Array.from(e),this.pos.copy(t.pos)}update(t){switch(super.update(t),this.state){case"stop":case"followBack":case"stickBack":this.spacing=Math.max(0,this.spacing-50*t);break;case"free":case"combine":this.spacing=Math.min(9,this.spacing+50*t)}switch(this.state){case"rotating":case"free":this.rotate+=t*Math.PI*8;break;case"stop":case"followBack":case"combine":this.rotate=0;break;case"stickBack":this.rotate=this.enemy.rotate}switch(this.state){case"stickBack":this.pos.copy(this.enemy.pos),this.pos.y-=14;break;case"free":case"combine":break;default:switch(e.copy(this.enemy.pos),this.state){case"followBack":e.y-=14;break;default:e.y+=10}e.sub(this.pos);const s=e.length();s<1&&"followBack"==this.state&&(this.state="stickBack"),e.normalize(),e.multiply(Math.min(s,50*t)),this.pos.add(e)}}followBack(){this.state="followBack"}render(t,e){super.render(t,e);for(let t=this.spacing>0?0:this.units.length-1;t<this.units.length;t++){const s=this.units[t];e.save(),e.translate(Math.floor((-(this.units.length-1)/2+t)*this.spacing+this.pos.x),Math.floor(this.pos.y)),e.rotate(this.rotate),e.drawImage(s.sprite,Math.floor(-s.sprite.width/2),Math.floor(-s.sprite.height/2)),e.restore()}}async setFree(){if("free"!=this.state){this.state="free",this.player.invincibleTime=9e3,this.player.canShoot=!1,this.cooperator.allowFlyOff=!1,this.cooperator.invincible=!0,this.cooperator.allowEnd=!1,t.Audio.play(t.Audio.sounds.capturedSuccess);try{await this.wait(3),this.state="combine",this.player.paused=!0;let t=!1;for(;!t;){const e=await this.wait(0),s=-9*(this.player.flightUnits.length+this.units.length-1)/2-this.player.flightUnits[0].pos.x,i=s-this.player.pos.x;this.player.pos.x+=Math.sign(i)*Math.min(100*e,Math.abs(i));const a=s+9*(this.player.flightUnits.length+this.units.length)/2-this.pos.x;this.pos.x+=Math.sign(a)*Math.min(100*e,Math.abs(a)),t=0==i&&0==a}let e=!1;for(;!e;){const t=await this.wait(0),s=this.player.pos.y-this.pos.y;this.pos.y+=Math.sign(s)*Math.min(100*t,Math.abs(s)),e=0==s}this.visible=!1,this.player.add(this.units),await this.wait(2)}catch(t){}finally{this.player.invincibleTime=0,this.player.paused=!1,this.player.canShoot=!0,this.cooperator.allowFlyOff=!0,this.cooperator.invincible=!1,this.cooperator.allowEnd=!0,this.removeFromManager()}}}}t.Kidnapper=class extends t.EnemyFlight{startFlyOff(t,e,i,a){this.flyOff||(!this.kidnapped&&Math.random()>.5?this.flyOff=new s(t,this,e,i,a):super.startFlyOff(t,e,i,a))}endFlyOff(){super.endFlyOff(),this.kidnapped&&"stop"==this.kidnapped.state&&this.kidnapped.followBack()}onDie(){this.kidnapped&&this.kidnapped.setFree(),super.onDie()}setCapture(t,e,s){if(this.manager){const a=new i(t,[e],this,s);a.state="stickBack",this.manager.add(a),this.kidnapped=a}}};class a extends t.GameObject{constructor(){super(),this.frames=[t.Sprites.shared.images.captureWave0,t.Sprites.shared.images.captureWave1,t.Sprites.shared.images.captureWave2],this.time=0,this.height=0,this.state="elongate",this.renderOrder=1}update(t){switch(super.update(t),this.time+=t,this.state){case"elongate":this.height=Math.min(1,this.height+t);break;case"shorten":this.height=Math.max(0,this.height-t)}}render(t,e){super.render(t,e);const s=this.frames[Math.floor(this.time/.1)%this.frames.length];let i=.2*Math.floor(this.height/.2);i=Math.floor(s.height*i),e.drawImage(s,0,0,s.width,i,Math.floor(this.pos.x-s.width/2),this.pos.y,s.width,i)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{}e.font="7px Trebuchet MS",e.BulletColor0="#E545FF",e.BulletColor1="#C62D3E",e.BulletColor2="#FFB950",e.BulletColor3="#3851FF",e.BulletColor4="#D1E0E3",e.BulletColor5="#FF2C61",e.BulletColor6="#FFEB48",e.BulletColor7="#3FEE3B",t.Palette=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=3;t.PlayerFlight=class extends t.GameObject{constructor(e,s,i){super(),this.stage=e,this.nextMember=s,this.allMemberRunOut=i,this.isPlayerFlight=!0,this.next=!1,this.invincibleTime=0,this.canShoot=!0,this.flightUnits=[],this.renderTime=0,this.poweredShot=new t.PlayerPoweredShot,this.reset(t.initMember)}update(e){super.update(e),this.invincibleTime-=e,this.pos.y>this.stage.bottom-35?this.pos.y=Math.max(this.pos.y-100*e,this.stage.bottom-35):(t.Input.shared.left&&(this.pos.x-=t.Constant.playerMoveSpeed*e),t.Input.shared.right&&(this.pos.x+=t.Constant.playerMoveSpeed*e));const s=9*this.flightUnits.length/2;this.pos.x=Math.max(this.pos.x,this.stage.left+s),this.pos.x=Math.min(this.pos.x,this.stage.right-s),this.next?(this.doNextMember(),this.next=!1):this.poweredShot.update(e,this);for(let t of this.flightUnits)t.powered&&t.pos.rotateAround(2*Math.PI*e)}async doNextMember(){this.invincibleTime=3,this.canShoot=!1,await this.wait(2);const s=this.nextMember();if(s){for(let e of this.flightUnits)t.knockdownMembers.push(e);this.reset(s),this.invincibleTime=e}else{for(let e of this.flightUnits)t.knockdownMembers.push(e);this.flightUnits.length=0,this.allMemberRunOut()}this.canShoot=!0}render(t,e){super.render(t,e),this.renderTime+=t;for(let t of this.flightUnits)t.powered&&(e.filter=`brightness(${Math.floor(400*Math.cos(2*Math.PI*this.renderTime/.5))}%)`,e.drawImage(t.sprite,Math.floor(this.pos.x+t.pos.x-t.sprite.width/2)+1,Math.floor(this.pos.y+t.pos.y-t.sprite.height/2)),e.drawImage(t.sprite,Math.floor(this.pos.x+t.pos.x-t.sprite.width/2)-1,Math.floor(this.pos.y+t.pos.y-t.sprite.height/2)),e.drawImage(t.sprite,Math.floor(this.pos.x+t.pos.x-t.sprite.width/2),Math.floor(this.pos.y+t.pos.y-t.sprite.height/2)+1),e.drawImage(t.sprite,Math.floor(this.pos.x+t.pos.x-t.sprite.width/2),Math.floor(this.pos.y+t.pos.y-t.sprite.height/2)-1),e.filter="none"),e.drawImage(t.sprite,Math.floor(this.pos.x+t.pos.x-t.sprite.width/2),Math.floor(this.pos.y+t.pos.y-t.sprite.height/2))}reset(t){this.flightUnits=[t],t.pos.set(0,0),this.visible=!0,this.pos.set(0,this.stage.bottom),this.poweredShot.assignGun(this)}add(t){const e=this.flightUnits.length>0?this.flightUnits[0].pos.x:0;for(let e of t)this.flightUnits.push(e);for(let t=0;t<this.flightUnits.length;t++){const e=this.flightUnits[t];e.pos.x=9*(t-(this.flightUnits.length-1)/2),e.pos.y=0}this.pos.x+=e-this.flightUnits[0].pos.x,this.poweredShot.assignGun(this)}remove(e){if(this.flightUnits.length>1){const s=this.flightUnits[0==e?1:0],i=s.pos.x;t.knockdownMembers.push(this.flightUnits.splice(e,1)[0]);for(let t=0;t<this.flightUnits.length;t++){const e=this.flightUnits[t];e.pos.x=9*(t-(this.flightUnits.length-1)/2),e.pos.y=0}this.pos.x+=i-s.pos.x,this.invincibleTime=1,this.poweredShot.assignGun(this)}else this.visible=!1,this.next=!0}};const s=new t.ColliderBox(new t.Vector2(9,9));t.FlightUnit=class{constructor(e,i){this.sprite=e,this.bulletColor=i,this.pos=new t.Vector2,this.collisionShape=s,this.powered=!1}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e={0:"./images/0.png",1:"./images/1.png",2:"./images/2.png",3:"./images/3.png",4:"./images/4.png",5:"./images/5.png",6:"./images/6.png",7:"./images/7.png",dog:"./images/dog.png",explod:"./images/explod.png",hand:"./images/hand.png",p:"./images/p.png",zombie1:"./images/zombie1.png",zombie2:"./images/zombie2.png",bullet:"./images/bullet.png",font:"./images/font.png",captureWave0:"./images/capture_wave0.png",captureWave1:"./images/capture_wave1.png",captureWave2:"./images/capture_wave2.png",grenade:"./images/grenade.png",explosion0:"./images/explosion0.png",explosion1:"./images/explosion1.png",explosion2:"./images/explosion2.png",bigZombie:"./images/bigZombie.png",blood0:"./images/blood0.png",blood1:"./images/blood1.png",blood2:"./images/blood2.png",heart0:"./images/heart0.png",heart1:"./images/heart1.png",bossTitle0:"./images/boss_title0.png",bossTitle1:"./images/boss_title1.png",kaijin:"./images/kaijin.png",laser0:"./images/laser0.png",laser1:"./images/laser1.png",laser2:"./images/laser2.png",laser3:"./images/laser3.png",laser4:"./images/laser4.png",laser5:"./images/laser5.png",laser6:"./images/laser6.png",laser7:"./images/laser7.png",laser8:"./images/laser8.png",blaser0:"./images/blaser0.png",blaser1:"./images/blaser1.png",blaser2:"./images/blaser2.png",blaser3:"./images/blaser3.png",blaser4:"./images/blaser4.png",blaser5:"./images/blaser5.png",blaser6:"./images/blaser6.png",blaser7:"./images/blaser7.png",blaser8:"./images/blaser8.png",powerup:"./images/powerup.png",ufo:"./images/ufo.png",cloud0:"./images/cloud0.png",cloud1:"./images/cloud1.png",cloud2:"./images/cloud2.png",cloud3:"./images/cloud3.png"};class s{constructor(){this.images={0:new Image,1:new Image,2:new Image,3:new Image,4:new Image,5:new Image,6:new Image,7:new Image,dog:new Image,explod:new Image,hand:new Image,p:new Image,zombie1:new Image,zombie2:new Image,bullet:new Image,font:new Image,captureWave0:new Image,captureWave1:new Image,captureWave2:new Image,grenade:new Image,explosion0:new Image,explosion1:new Image,explosion2:new Image,bigZombie:new Image,blood0:new Image,blood1:new Image,blood2:new Image,heart0:new Image,heart1:new Image,bossTitle0:new Image,bossTitle1:new Image,kaijin:new Image,laser0:new Image,laser1:new Image,laser2:new Image,laser3:new Image,laser4:new Image,laser5:new Image,laser6:new Image,laser7:new Image,laser8:new Image,blaser0:new Image,blaser1:new Image,blaser2:new Image,blaser3:new Image,blaser4:new Image,blaser5:new Image,blaser6:new Image,blaser7:new Image,blaser8:new Image,powerup:new Image,ufo:new Image,cloud0:new Image,cloud1:new Image,cloud2:new Image,cloud3:new Image}}load(){return Promise.all(Object.getOwnPropertyNames(e).map(t=>(function(t,e){return new Promise((s,i)=>{t.src=e,t.onload=(()=>s()),t.onerror=(t=>i(t))})})(this.images[t],e[t])))}}s.shared=new s,t.Sprites=s}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.ColliderBox(new t.Vector2(6,6));t.Grenade=class extends t.EnemyBullet{constructor(t,e,i,a,o=0){super(t,e,i,a),this.phase=o,this.time=0,this.playerBullet=!1,this.collisionShape=s,this.shouldCollidePlayerBullet=(()=>!0),this.onCollidePlayerBullet=((t,e)=>{this.velocity.y*=-1,this.color=t.color,this.playerBullet=!0,this.canHitPlayer=!1,t.onHitEnemy(e),this.shouldCollidePlayerBullet=(()=>!1),this.onCollidePlayerBullet=void 0})}update(s){if(super.update(s),this.time+=s,this.manager&&this.time>1){for(let s=0;s<8;s++){const i=s*Math.PI*2/8+this.phase;let a;this.playerBullet?(a=new t.PlayerBullet(this.stage,this.color)).velocity.set(Math.sin(i),-Math.cos(i)).multiply(t.Constant.bulletSpeed):a=new t.EnemyBullet(this.stage,e.set(Math.sin(i),-Math.cos(i)),this.shooter),a.pos.copy(this.pos),this.manager.add(a)}this.removeFromManager()}}render(e,s){const i=t.Sprites.shared.images.grenade;s.save(),s.translate(Math.floor(this.pos.x),Math.floor(this.pos.y)),s.rotate(this.time*Math.PI*4),s.drawImage(i,Math.floor(-i.width/2),Math.floor(-i.height/2)),s.restore()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{async getRecords(){return new t.APIRequest("leaderboard").get()}async post(e,s,i,a){await new t.APIRequest("leaderboard").post({name:e,score:s,wave:i,uuid:a})}}e.shared=new e,t.Leaderboard=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e="- BEST 8 -",s="RANK  SCORE WAVE INT";t.LeaderboardScreen=class extends t.GameObject{constructor(e,s=(()=>{})){super(),this.onKeyPress=s,this.records=[],this.time=0,this.renderHalf=!1,this.renderOrder=1,t.Leaderboard.shared.getRecords().then(t=>{this.records=t,this.records.length>0&&e.updateHiScore(this.records[0].score)}).catch(e=>{t.ErrorHandler.handle(e)})}update(e){super.update(e),this.time+=e,this.time>=1&&t.Input.shared.pressAnyKey&&this.onKeyPress()}render(i,a){super.render(i,a),a.save(),a.translate(0,-50),t.TextDrawer.shared.drawTextOutline(e,-t.TextDrawer.shared.measure(e)/2,0,a),t.TextDrawer.shared.drawTextOutline(s,-t.TextDrawer.shared.measure(s)/2,7,a),a.translate(0,14);for(let e=0,s=Math.min(8,this.records.length);e<s;e++){const s=this.records[e],i=` ${0==e?"1ST":1==e?"2ND":2==e?"3RD":`${e+1}TH`} ${t.addLeadingZero(Math.min(t.highestScoreDisplay,s.score),6)}  ${t.addLeadingZero(s.wave||0,3)} ${s.name}`;t.TextDrawer.shared.drawTextOutline(i,-t.TextDrawer.shared.measure(i)/2,0,a),a.translate(0,7)}a.restore()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e="ZTIwZmI0OTI3YmI1NjU4MjZlMjE5NDY0OTA1MjI5ZDA=";t.APIRequest=class{constructor(t){this.url=t}async get(){return(await fetch(this.url)).json()}async post(t){const s=JSON.stringify(t),i=`${Math.random()+Date.now()}`,a=await async function(t){const e=(new TextEncoder).encode(t),s=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(s)).map(t=>t.toString(16).padStart(2,"0")).join("")}(s+i+atob(e)),o=await fetch(this.url,{method:"POST",body:JSON.stringify({payload:s,digest:a,salt:i})}),r=await o.json();if("OK"!=r.state)throw new Error(r)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e={},s=document.createElement("audio");s.volume=t.Constant.volume;class i{static preload(){const s=[];for(let t in i.sounds)s.push(i.sounds[t]);return Promise.all(s.map(s=>(function(s){return new Promise((i,a)=>{const o=document.createElement("audio");o.src=s,o.autoplay=!1,o.volume=t.Constant.volume,o.oncanplay=(()=>i()),o.onerror=(t=>a(t)),e[s]=o})})(s)))}static playBgm(t){s.currentTime=0,s.autoplay=!0,s.loop=!0,s.src=t}static play(t){e[t].currentTime=0,e[t].play()}static stop(t){e[t].pause()}static get volume(){return e[this.sounds.bonus].volume}static set volume(t){for(let s in e)e[s].volume=t;s.volume=t}}i.sounds={explosion:"./sound/explosion.wav",invaderkilled:"./sound/invaderkilled.wav",shoot:"./sound/shoot.wav",shipFly:"./sound/Galaxian Sound.mp3",bonus:"./sound/Galaxian.mp3",captureBeam:"./sound/capture_beam.mp3",captureBeam2:"./sound/capture_beam2.mp3",captured:"./sound/captured.mp3",capturedSuccess:"./sound/captured_success.mp3",credit:"./sound/8d82b5_Galaga_Coin_Sound_Effect.mp3",enemyShooting:"./sound/8d82b5_Galaga_Firing_Sound_Effect.mp3",eyeLaser:"./sound/8-bit-cannon-fire-96505.mp3",fingerLaser:"./sound/268168__shaun105__laser.wav",alienShip:"./sound/257219__javierzumer__8bit-wc.wav"},t.Audio=i;new t.Constant}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2(-4,70),s=new t.ColliderCompoundShape,i=new t.ColliderBox(new t.Vector2(6,223));t.BigLaser=class extends t.PlayerBullet{constructor(e,s){super(e.stage,"#0042FF"),this.player=e,this.unit=s,this.cooldown=0,this.damage=1.5,this.cancelEnemyBullet=!0,this.animation=new t.AnimatedSpriteObject([t.Sprites.shared.images.blaser0,t.Sprites.shared.images.blaser1,t.Sprites.shared.images.blaser2,t.Sprites.shared.images.blaser3,t.Sprites.shared.images.blaser4,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser7,t.Sprites.shared.images.blaser8],.05),this.animation.pos=this.pos,this.animation.removeFromManager=(()=>{this.removeFromManager()})}onHitEnemy(t){this.spark(t),this.cooldown=.1}update(t){super.update(t),this.animation.update(t),this.pos.add(this.player.pos,this.unit.pos).sub(e),this.pos.y-=10,this.cooldown-=t,this.animation.frame>=5&&this.animation.frame<17&&this.cooldown<=0?this.collisionShape=i:this.collisionShape=s}render(t,e){this.animation.render(t,e)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=[t.Sprites.shared.images.blood0,t.Sprites.shared.images.blood1,t.Sprites.shared.images.blood2];class i extends t.SpriteObject{constructor(t){super(s[t]),this.time=0,this.renderOrder=-1}update(t){super.update(t),this.time+=t,this.time>=2&&this.removeFromManager()}}t.BloodStainOverAnyWhere=class extends t.GameObject{async drop(a,o=1){let r=0;t.Audio.play(t.Audio.sounds.explosion);for(let t=0;t<30;t++)for(r+=await this.wait(0);r>=.0125;){for(let t=0;t<o;t++){const t=new i(Math.floor(Math.random()*s.length));t.pos.copy(this.pos).add(e.random().multiply(2).add(-1).normalize().multiply(Math.random()*a)),this.manager&&this.manager.add(t)}r-=.0125}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2;t.BossTitle=class extends t.GameObject{async show(){if(this.manager){await this.wait(2);const s=new t.SpriteObject(t.Sprites.shared.images.bossTitle0);s.pos.copy(this.pos),s.pos.x+=200,this.manager.add(s),await t.ObjectMotionControl.moveTo(s,e.set(0,0),1e3),await this.wait(.5);const i=new t.SpriteObject(t.Sprites.shared.images.bossTitle1);i.pos.copy(this.pos),i.pos.x+=200,this.manager.add(i),await t.ObjectMotionControl.moveTo(i,e.set(0,0),1e3),await this.wait(3),this.wait(2).then(()=>{s.removeFromManager(),i.removeFromManager(),this.removeFromManager()})}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{constructor(){this.cache=new WeakMap}get(t,e){const s=this.cache.get(e)||{};this.cache.set(e,{});let i=s[t];if(!i){(i=document.createElement("canvas")).width=e.width,i.height=e.height;const a=i.getContext("2d");a.fillStyle=t,a.fillRect(0,0,i.width,i.height),a.globalCompositeOperation="destination-in",a.drawImage(e,0,0),s[t]=i}return i}}e.shared=new e,t.ColoredSprite=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.ContinueScreen=class extends t.GameObject{constructor(t){super(),this.continueFunc=t,this.countDown=9,this.countCoolDown=1,this.renderOrder=1,this.renderHalf=!1}update(e){super.update(e),t.Input.shared.pressAnyKey&&this.countDown<9?(this.continueFunc(!0),this.removeFromManager()):(this.countCoolDown-=e,this.countCoolDown<=0&&(this.countDown<=0?(this.continueFunc(!1),this.removeFromManager()):(this.countDown-=1,this.countCoolDown+=1)))}render(e,s){super.render(e,s);const i=`CONTINUE? ${this.countDown}`;t.TextDrawer.shared.drawText(i,Math.floor(-t.TextDrawer.shared.measure(i)/2),-2,s)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{getProfile(t){return{extraFlyOffRate:.01*Math.floor(t/10),bulletCount:Math.floor((t+4)/5),bulletInterval:1/Math.floor((t+5)/6),hp:1+Math.floor(Math.min(30,t)/6)}}}e.shared=new e,t.DifficultyManager=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=["INSPIRED BY","ZOMBIELAND SAGA THE BEST REVENGE","","","","-GAME DESIGNER-","ANMC","","-PROGRAMMER-","ANMC","","-PIXEL GRAPHICS DESIGNER-","ANMC","","ACKNOWLEDGEMENT","","-BG MUSIC-","ADABANA NECROMANCY 8-BIT VERSION","OHNO COLON 8BIT MUSIC","","REVENGE 8-BIT VERSION","OHNO COLON 8BIT MUSIC","","YOMIGAERE 8-BIT VERSION","OHNO COLON 8BIT MUSIC","","TAIGAYOTOMONINAITEKURE 8-BIT VERSION","OHNO COLON 8BIT MUSIC","","","-SOUND EFFECT-","CLASSIC GAMING.CC","SOUND FX CENTER","SHAUN105","","-SPRITES-","THE SPRITES RESOURCE","","","","AND YOU","","","","PRESENTED BY DANBORUTORI"];class s extends t.GameObject{constructor(t){super(),this.showHighestScore=t}async showCredits(s){if(!this.manager)return;const i=this.manager.gameObjects.find(t=>t.isStarNight),a=s.bottom+11,o=s.top-11,r=(a-o)/10;for(let s=0;s<e.length;s++){const n=e[s];switch(s){case 5:i.state="starSky";break;case 14:i.state="burning";break;case 33:i.state="whiteout";break;case 34:i.state="bluesky"}const h=new t.FloatingText(n,void 0,r);h.pos.set(0,a),this.manager.add(h),t.ObjectMotionControl.moveTo(h,new t.Vector2(0,o),10),await this.wait(1)}await this.wait(r+2)}async start(e){if(this.manager){for(await this.wait(3),this.manager.add(new t.FloatingText("THE CURSE OF SAGA...",void 0,3)),await this.wait(3),this.manager.add(new t.FloatingText("IS DEFEATED.",void 0,5)),await this.wait(5),this.manager.add(new t.FloatingText("YOU SAVED SAGA...",void 0,3)),await this.wait(3),this.manager.add(new t.FloatingText("JUST A LITTLE BIT.",void 0,5)),await this.wait(5),this.manager.add(new t.FloatingText("THANK YOU FOR PLAYING.",void 0,5)),await this.wait(5),e.nextCredit=Number.MAX_SAFE_INTEGER;e.credit>0;){e.score+=5e3,e.credit--;const s=new t.FloatingText("5000");s.pos.set(e.stage.right-12,e.stage.bottom-20),this.manager.add(s),t.ObjectMotionControl.moveTo(s,new t.Vector2(0,-5).add(s.pos),50),t.Audio.play(t.Audio.sounds.credit),await this.wait(.5)}await this.wait(2),await this.showCredits(e.stage),this.showHighestScore()}}}t.EndingWave=class{constructor(t){this.showHighestScore=t,this.pause=!1}async showTitle(t,e){}init(t,e,i){const a=new s(this.showHighestScore);e.add(a),a.start(t)}clear(){}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.Zombie1=class extends t.Kidnapper{constructor(e,s){super(t.Sprites.shared.images.zombie1,s,50,e)}};t.Zombie2=class extends t.EnemyFlight{constructor(e,s){super(t.Sprites.shared.images.zombie2,s,50,e),this.bulletIntervalScale=.5,this.bulletShootAngle=15*Math.PI/180}};t.Hand=class extends t.EnemyFlight{constructor(e,s){super(t.Sprites.shared.images.hand,s,50,e),this.bulletCountDelta=-1}bulletFactoty(e){return new t.Grenade(this.scorer.stage,e,this)}};t.Dog=class extends t.EnemyFlight{constructor(e,s){super(t.Sprites.shared.images.dog,s,50,e),this.homingTime=2.5}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=9;t.EnemyCooperator=class extends t.GameObject{constructor(e,s,i,a){super(),this.stage=s,this.waveEnd=a,this.cooldown=0,this.moveDir="left",this.allowFlyOff=!0,this.allowEnd=!0,this.difficultyProfile=t.DifficultyManager.shared.getProfile(e),this.enemies=i.map(t=>({enemy:t,initPos:t.pos.clone(),targetPos:t.pos.clone()}))}set invincible(t){for(let e of this.enemies)e.enemy.invincible=t}update(t){if(super.update(t),this.cooldown-=t,this.cooldown<=0){const t=this.enemies.reduce((t,e)=>t+(e.enemy.manager?1:0),0)/(this.enemies.length-1),s=(.01+.49*t)/.6,i=.6*(3+6*(1-t)),a=.005+.1*(1-t)+this.difficultyProfile.extraFlyOffRate;let o=0;switch(this.moveDir){case"left":let t=Number.MAX_VALUE;for(let e of this.enemies)e.enemy.manager&&(t=Math.min(e.targetPos.x,t));t<=this.stage.left+e&&(this.moveDir="right");break;case"right":let s=Number.MIN_VALUE;for(let t of this.enemies)t.enemy.manager&&(s=Math.max(t.targetPos.x,s));s>=this.stage.right-e&&(this.moveDir="left")}switch(this.moveDir){case"left":o=-i;break;case"right":o=i}if(this.allowFlyOff)for(let t of this.enemies)t.targetPos.x+=o,!t.enemy.isFlyingOff&&Math.random()<a&&t.enemy.startFlyOff(this,t.targetPos,this.difficultyProfile.bulletInterval*t.enemy.bulletIntervalScale,this.difficultyProfile.bulletCount+t.enemy.bulletCountDelta);this.cooldown+=s}for(let t of this.enemies)t.enemy.isFlyingOff||(t.enemy.pos.copy(t.targetPos),t.enemy.vel.set(0,0));this.allowEnd&&(this.enemies.reduce((t,e)=>t||void 0!==e.enemy.manager,!1)||this.waveEnd())}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.ErrorHandler=class{static handle(t){}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.Explosion=class extends t.SpriteObject{constructor(){super(t.Sprites.shared.images.explod),this.lifeTime=0,t.Audio.play(t.Audio.sounds.invaderkilled)}update(t){super.update(t),this.lifeTime+=t,this.lifeTime>.1&&this.manager&&this.removeFromManager()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=1,a=.2;t.FingerBeam=class extends t.PlayerBullet{constructor(e,s,i){super(e.stage,s.bulletColor),this.shooter=e,this.unit=s,this.clockwise=i,this.time=0,this.hitCooldown=0,this.isHit=!1,this.collisionShape=new t.ColliderLineSegment,this.cancelEnemyBullet=!0,this.damage=.1}get canHit(){return this.hitCooldown<=0}update(e){super.update(e),this.time+=e,this.hitCooldown>0&&(this.hitCooldown-=e),this.pos.add(this.shooter.pos,this.unit.pos),this.pos.y-=6,this.collisionShape.from.set(0,0),this.collisionShape.to.set(0,-400).rotateAround(t.mix(Math.PI/2*this.clockwise,-Math.PI/2*this.clockwise,Math.pow(this.time/i,.25))),this.time>=i&&this.removeFromManager(),this.isHit&&(this.hitCooldown+=a,this.isHit=!1)}onHitEnemy(t){this.spark(t),this.isHit=!0}render(a,o){o.fillStyle=this.color;const r=1-this.time/i;e.add(this.collisionShape.from,this.pos),s.add(this.collisionShape.to,this.pos),t.drawLine(e,s,3*r,o),o.fillStyle="white",r>.3&&t.drawLine(e,s,1*r,o)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2(0,0),i=new t.Vector2(0,1),a=(new t.Transform,new t.Transform);class o{constructor(t){this.value=t}getValue(t,e){return this.value}}t.ConstantNode=o;t.IntervalNode=class{constructor(t,e){this.interval=t,this.next=e,this.cooldown=0}update(t,e,s){for(;t-this.cooldown>=this.interval.getValue(t,e);)this.next.update(t,e,s),this.cooldown+=this.interval.getValue(t,e)}};t.EnemyBulletNode=class{constructor(t=new o(s),e=new o(i),a){this.offset=t,this.directon=e,this.speed=a}update(s,i,a){if(i.manager){const o=new t.EnemyBullet(i.scorer.stage,e.copy(this.directon.getValue(s,i)).rotateAround(a.rotation),i,this.speed&&this.speed.getValue(s,i));o.pos.add(i.pos,this.offset.getValue(s,i)).add(a.translation),i.manager.add(o),t.Audio.play(t.Audio.sounds.enemyShooting)}}};t.GrendaeNode=class{constructor(t=new o(s),e=new o(i),a,r){this.offset=t,this.directon=e,this.speed=a,this.phase=r}update(s,i,a){if(i.manager){const o=new t.Grenade(i.scorer.stage,e.copy(this.directon.getValue(s,i)).rotateAround(a.rotation),i,this.speed&&this.speed.getValue(s,i),this.phase&&this.phase.getValue(s,i));o.pos.add(i.pos,this.offset.getValue(s,i)).add(a.translation),i.manager.add(o),t.Audio.play(t.Audio.sounds.enemyShooting)}}};t.RingNode=class{constructor(e,s,i){this.radius=e,this.segment=s,this.next=i,this.t=new t.Transform}update(t,e,s){for(let i=0,a=this.segment.getValue(t,e);i<a;i++)this.t.rotation=2*Math.PI*i/a,this.t.translation.set(0,this.radius.getValue(t,e)).rotateAround(this.t.rotation),this.t.multiply(s),this.next.update(t,e,this.t)}};t.SineNode=class{constructor(e,s,i=new o(0)){this.period=e,this.angle=s,this.phase=i,this.v1=new t.Vector2}getValue(t,e){let s=this.angle.getValue(t,e)*Math.cos(t/this.period.getValue(t,e)+this.phase.getValue(t,e));return this.v1.set(0,1).rotateAround(s)}};t.FlightShootPatternControl=class{static shoot(t,e){let s=!1;return(async()=>{try{let i=0;for(;!s;)i+=await t.wait(0,void 0,"shot"),e&&e.update(i,t,a)}catch(t){}})(),{stop:()=>{s=!0}}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.FloatingText=class extends t.GameObject{constructor(t,e,s=3){super(),this.text=t,this.onRemove=e,this.duration=s,this.time=0,this.renderHalf=!1}update(t){super.update(t),this.time+=t,this.time>this.duration&&(this.onRemove&&this.onRemove(),this.removeFromManager())}render(e,s){super.render(e,s),t.TextDrawer.shared.drawText(this.text,Math.floor(this.pos.x-t.TextDrawer.shared.measure(this.text)/2),Math.floor(this.pos.y),s)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.initMember=new t.FlightUnit(t.Sprites.shared.images[1],t.Palette.BulletColor1);const e=[new t.FlightUnit(t.Sprites.shared.images[5],t.Palette.BulletColor5),new t.FlightUnit(t.Sprites.shared.images[6],t.Palette.BulletColor6)];t.missingMembers=[new t.FlightUnit(t.Sprites.shared.images[4],t.Palette.BulletColor4),new t.FlightUnit(t.Sprites.shared.images[2],t.Palette.BulletColor2),new t.FlightUnit(t.Sprites.shared.images[3],t.Palette.BulletColor3),new t.FlightUnit(t.Sprites.shared.images[0],t.Palette.BulletColor0),new t.FlightUnit(t.Sprites.shared.images.p,t.Palette.BulletColor1)],t.knockdownMembers=[];let s=new t.FlightUnit(t.Sprites.shared.images[7],t.Palette.BulletColor7);t.Franchouchou=class extends t.GameObject{constructor(t,s){super(),this.stage=t,this.manager=s,this.units=[],this.renderOrder=1,this.reset(e)}get remainingMember(){return this.units.length}get nextMember(){return this.units.length>0?this.units.pop():null}render(t,e){super.render(t,e);for(let t=0;t<this.units.length;t++){const s=this.units[t].sprite;e.drawImage(s,Math.floor(this.stage.left+15+11*t-s.width/2),Math.floor(this.stage.bottom-9-s.height/2))}}onBeforeContinue(){0==t.knockdownMembers.length&&s&&(t.knockdownMembers.push(s),s=void 0)}reset(t){this.units=Array.from(t)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.ImageButton=class{constructor(t,e,s){t.src=e,t.addEventListener("touchstart",e=>{t.src=s,e.preventDefault()}),t.addEventListener("touchmove",t=>t.preventDefault()),t.addEventListener("touchend",s=>{t.src=e,s.preventDefault()}),t.addEventListener("touchcancel",s=>{t.src=e,s.preventDefault()})}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){class e{constructor(){this.left=!1,this.right=!1,this.fire=!1,this.pressAnyKey=!1,addEventListener("keydown",t=>{switch(t.code){case"ArrowLeft":case"KeyA":this.left=!0,this.pressAnyKey=!0;break;case"ArrowRight":case"KeyD":this.right=!0,this.pressAnyKey=!0;break;case"ArrowUp":case"KeyW":this.fire=!0,this.pressAnyKey=!0}}),addEventListener("keyup",t=>{switch(t.code){case"ArrowLeft":case"KeyA":this.left=!1;break;case"ArrowRight":case"KeyD":this.right=!1;break;case"ArrowUp":case"KeyW":this.fire=!1}})}init(t,e,s){const i=()=>{this.left=a||o,this.right=r||n,this.fire=h||l};let a=!1,o=!1,r=!1,n=!1,h=!1,l=!1;t.addEventListener("touchstart",t=>{a=!0,this.pressAnyKey=!0,i()}),t.addEventListener("pointerdown",t=>{o=!0,this.pressAnyKey=!0,i()}),e.addEventListener("touchstart",t=>{r=!0,this.pressAnyKey=!0,i()}),e.addEventListener("pointerdown",t=>{n=!0,this.pressAnyKey=!0,i()}),s.addEventListener("touchstart",t=>{h=!0,this.pressAnyKey=!0,i()}),s.addEventListener("pointerdown",t=>{l=!0,this.pressAnyKey=!0,i()}),t.addEventListener("touchend",t=>{a=!1,i()}),t.addEventListener("touchcancel",t=>{a=!1,i()}),t.addEventListener("pointerup",t=>{o=!1,i()}),t.addEventListener("pointerout",t=>{o=!1,i()}),e.addEventListener("touchend",t=>{r=!1,i()}),e.addEventListener("touchcancel",t=>{r=!1,i()}),e.addEventListener("pointerup",t=>{n=!1,i()}),e.addEventListener("pointerout",t=>{n=!1,i()}),s.addEventListener("touchend",t=>{h=!1,i()}),s.addEventListener("touchcancel",t=>{h=!1,i()}),s.addEventListener("pointerup",t=>{l=!1,i()}),s.addEventListener("pointerout",t=>{l=!1,i()})}update(){this.pressAnyKey=!1}}e.shared=new e,t.Input=e}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.ColliderCompoundShape;s.shapes.push({shape:new t.ColliderBox(new t.Vector2(62,75)),pos:new t.Vector2(11,-1)}),s.shapes.push({shape:new t.ColliderBox(new t.Vector2(34,39)),pos:new t.Vector2(-28,-6)});const i=500,a=.2,o=1e4;class r extends t.EnemyFlight{constructor(e,a=i,r=o/2){super(t.Sprites.shared.images.kaijin,e,r,a),this.collisionShape=s}wrapAround(){}playExplosionAnimation(){if(this.manager){const e=new t.BloodStainOverAnyWhere;e.pos.copy(this.pos),this.manager.add(e),e.drop(80)}}async playAttackSequence(e){const s=new t.Vector2;try{await t.ObjectMotionControl.moveTo(this,s.set(0,-30),50),await this.wait(3),await Promise.all([this.attackPhase1(e),this.attackPhase2(e)])}catch(t){}}async attackPhase1(e){const s=new t.Vector2;try{for(let i=0;;i++){for(let i=0;i<3;i++)for(let a=0;a<3;a++){let o=e.left+40,r=e.right-40;if(i%2==1){const t=o;o=r,r=t}const n=t.mix(e.top+40,e.bottom-50,a/3);this.simpleShoot(),await t.ObjectMotionControl.moveTo(this,s.set(o,n),200),await this.wait(.5),this.simpleShoot(),await t.ObjectMotionControl.moveTo(this,s.set(r,n),200),await this.wait(.5)}await this.dash(e,(e.left+40)*Math.sin(i*Math.PI*2/3),i%2==1)}}catch(t){}}async attackPhase2(e){const s=new t.Vector2;try{for(;this.hp>=i*a;)await this.wait(0,1);this.terminateAllWaiting(),await t.ObjectMotionControl.moveTo(this,s.set(0,-30),50),await this.wait(2);let o=0;for(let i=0;;i++){for(let s of[new t.Vector2(0,this.pos.y),new t.Vector2(e.left+40,this.pos.y),new t.Vector2(0,this.pos.y),new t.Vector2(e.right-40,this.pos.y)]){if(i%2==1){switch((o+i)%4){case 1:this.throwGrenade(.15);break;case 3:this.simpleShoot(.4)}o++}await t.ObjectMotionControl.moveTo(this,s,200),this.shotLaser(),await this.wait(1)}i>2&&(i%2==0?(await t.ObjectMotionControl.moveTo(this,s.set(10,-30),100),await this.wait(2),await this.movingLaser(s.set(e.left+40,this.pos.y))):(await t.ObjectMotionControl.moveTo(this,s.set(-10,-30),100),await this.wait(2),await this.movingLaser(s.set(e.right-40,this.pos.y))),await this.wait(1))}}catch(t){}}async simpleShoot(e=.2){const s=t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.05),new t.RingNode(new t.ConstantNode(3),new t.ConstantNode(12),new t.EnemyBulletNode(new t.ConstantNode(new t.Vector2(0,-20)),void 0,new t.ConstantNode(50)))));await this.wait(e),s.stop()}async throwGrenade(e=.2){const s=[t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.06),new t.RingNode(new t.ConstantNode(10),new t.ConstantNode(6),new t.GrendaeNode(new t.ConstantNode(new t.Vector2(-28,-21)),void 0,new t.ConstantNode(50),{getValue:t=>t/.06*60*Math.PI/180})))),t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.06),new t.RingNode(new t.ConstantNode(10),new t.ConstantNode(6),new t.GrendaeNode(new t.ConstantNode(new t.Vector2(33,8)),void 0,new t.ConstantNode(50),{getValue:t=>t/.06*60*Math.PI/180}))))];await this.wait(e);for(let t of s)t.stop()}shotLaser(){if(this.manager){const e=new l(this.scorer.stage,this);this.manager.add(e),t.Audio.play(t.Audio.sounds.eyeLaser)}}async movingLaser(e){this.shotLaser(),await this.wait(.25),await t.ObjectMotionControl.moveTo(this,e,100)}async dash(e,s,i){const a=new t.Vector2;await t.ObjectMotionControl.moveTo(this,a.set(s,-30),50),await this.wait(2),this.throwGrenade(),await t.ObjectMotionControl.moveTo(this,a.set(s,e.top+40),200),await this.wait(.1),await t.ObjectMotionControl.moveTo(this,a.set(s,e.bottom-40),200),await this.wait(1),i&&this.simpleShoot(),await t.ObjectMotionControl.moveTo(this,a.set(s,-30),200),await this.wait(1)}}const n=new t.ColliderCompoundShape,h=new t.ColliderCompoundShape;h.shapes.push({shape:new t.ColliderBox(e.set(7,167)),pos:new t.Vector2(12,28)}),h.shapes.push({shape:new t.ColliderBox(e.set(7,167)),pos:new t.Vector2(-12,28)});class l extends t.EnemyBullet{constructor(s,i){super(s,e.set(0,0),i,0),this.collisionShape=n,this.shouldCollidePlayerBullet=(()=>!1),this.animation=new t.AnimatedSpriteObject([t.Sprites.shared.images.laser0,t.Sprites.shared.images.laser1,t.Sprites.shared.images.laser2,t.Sprites.shared.images.laser3,t.Sprites.shared.images.laser4,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser5,t.Sprites.shared.images.laser6,t.Sprites.shared.images.laser7,t.Sprites.shared.images.laser8],.05),this.animation.pos=this.pos,this.animation.removeFromManager=(()=>{this.removeFromManager()}),this.pos.add(this.shooter.pos,e.set(2,56))}onHitPlayer(){}update(t){super.update(t),this.animation.update(t),this.pos.add(this.shooter.pos,e.set(2,56)),this.animation.frame>=5&&this.animation.frame<17?this.collisionShape=h:this.collisionShape=n}render(t,e){super.render(t,e),this.animation.render(t,e)}}t.KaijinWave=class extends t.BossEnemyWave{constructor(t,e){super(e),this.onWaveEnd=t}init(e,s,i){const a=new t.GameObject;s.add(a);const o=new r(e);o.pos.set(0,e.stage.top-40),this.enemies.push(o),s.add(o);const n=this.dropPowerUp(e,s);o.playAttackSequence(e.stage).then(async()=>{n.stop(),await a.wait(5),a.removeFromManager(),this.onWaveEnd()})}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.Main=class{constructor(){this.allowUpdate=!0,this.gameObjectManager=new t.GameObjectManager,this.ctx=null,this.halfRenderContext=null,this.stage={left:0,right:0,top:0,bottom:0},this.waveManager=new t.WaveManager,this.wave=0}async init(e){this.ctx=e.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1);const s=document.createElement("canvas");return s.width=e.width/2,s.height=e.height/2,this.halfRenderContext=s.getContext("2d"),this.halfRenderContext&&(this.halfRenderContext.imageSmoothingEnabled=!1),await Promise.all([t.Sprites.shared.load(),t.Audio.preload()]),this.initGame(),this}initGame(){const e=new t.ScoreAndCredit(this.stage,{get remainingMember(){return i.remainingMember+s.flightUnits.length}});this.ctx&&(this.stage.left=-this.ctx.canvas.width/4,this.stage.right=this.ctx.canvas.width/4,this.stage.top=-this.ctx.canvas.height/4,this.stage.bottom=this.ctx.canvas.height/4),this.gameObjectManager.add(new t.StarNight(this.stage));const s=new t.PlayerFlight(this.stage,()=>i.nextMember,()=>{this.showContinue(e,s,i)});s.pos.y=this.stage.bottom-35,this.gameObjectManager.add(s),this.resetEnemies(s,e,()=>i.nextMember);const i=new t.Franchouchou(this.stage,this.gameObjectManager);this.gameObjectManager.add(i),this.gameObjectManager.add(e),s.paused=!0,this.waveManager.pause=!0;const a=new t.StartScreen(e,()=>{s.paused=!1,this.waveManager.pause=!1});this.gameObjectManager.add(a),this.gameObjectManager.add(a.leaderboard)}resetEnemies(t,e,s){this.waveManager.init(this.wave,e,this.gameObjectManager,t,s,()=>{this.wave+=1,this.resetEnemies(t,e,s),t.paused=!0,t.invincibleTime=9e3,this.waveManager.pause=!0,this.waveManager.showTitle(this.gameObjectManager,this.wave+1).then(()=>{t.paused=!1,t.invincibleTime=0,this.waveManager.pause=!1})},()=>{this.showHighestScore(e,t)})}showContinue(e,s,i){if(i.onBeforeContinue(),t.knockdownMembers.length>0)if(e.credit>0){s.paused=!0,this.waveManager.pause=!0;const a=new t.ContinueScreen(a=>{a?(e.credit--,s.paused=!1,this.waveManager.pause=!1,s.reset(t.knockdownMembers[0]),i.reset(t.knockdownMembers.slice(1)),t.knockdownMembers.length=0,s.invincibleTime=1):this.showHighestScore(e,s)});this.gameObjectManager.add(a)}else s.paused=!0,this.waveManager.pause=!0,this.showHighestScore(e,s);else{s.paused=!0,this.waveManager.pause=!0;const i=new t.FloatingText("ALL MEMBERS CAPTURED",()=>{this.showHighestScore(e,s)});this.gameObjectManager.add(i)}}async showHighestScore(e,s){try{const i=new t.PostScorePanel;this.gameObjectManager.add(i),await i.postScore(e,this.wave+1,s)}catch(t){console.error(t)}const i=new t.LeaderboardScreen(e,()=>{location.reload()});this.gameObjectManager.add(i)}onMute(e){0!=t.Audio.volume?(t.Audio.volume=0,e.value="SOUND ON"):(t.Audio.volume=t.Constant.volume,e.value="SOUND OFF")}run(){let e=performance.now();setInterval(()=>{if(this.allowUpdate){const s=performance.now(),i=Math.min(t.Constant.maxTimeStep,(s-e)/1e3);this.update(i),e=s}},10)}update(e){this.render(e),this.gameObjectManager.update(e),t.Input.shared.update()}render(t){this.allowUpdate=!1,requestAnimationFrame(()=>{if(this.halfRenderContext){const e=this.halfRenderContext.canvas.width,s=this.halfRenderContext.canvas.height;this.halfRenderContext.save(),this.halfRenderContext.translate(e/2,s/2),this.gameObjectManager.renderHalf(t,this.halfRenderContext),this.halfRenderContext.restore(),this.ctx&&(this.ctx.drawImage(this.halfRenderContext.canvas,0,0,e,s,0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.save(),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.scale(2,2),this.gameObjectManager.render(t,this.ctx),this.ctx.restore())}this.allowUpdate=!0})}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=[t.Sprites.shared.images.explosion0,t.Sprites.shared.images.explosion1,t.Sprites.shared.images.explosion2];t.MemberExplosion=class extends t.SpriteObject{constructor(){super(e[0]),this.time=0}update(t){this.time+=t,this.sprite=e[Math.floor(this.time/.1)],this.time>=.3&&this.removeFromManager()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=.1;t.ObjectMotionControl=class{static async moveTo(s,i,a){const o=new t.Vector2;for(;o.sub(i,s.pos).length()>e;){const t=await s.wait(0,void 0,"move to"),e=o.length();o.normalize().multiply(Math.min(a*t,e)),s.pos.add(o)}}static async moveCircle(e,s,i,a,o,r){const n=new t.Vector2;for(let t=0;t<64;t++)n.set(0,-i).rotateAround(2*Math.PI*t/64*(o?1:-1)+a).add(s),await this.moveTo(e,n,r)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=2,s=.3;class i{constructor(t,e){this.playerFlight=t,this.unit=e,this.cooldown=0}update(t){this.cooldown>0&&(this.cooldown-=t)}shot(){this.cooldown<=0&&(this.makeBullet(),this.cooldown+=this.interval)}}class a extends i{constructor(e,s,i){super(e,s),this.angle=i,this.interval=t.Constant.playerFireInterval}makeBullet(){if(this.playerFlight.manager){const e=new t.PlayerBullet(this.playerFlight.stage,this.unit.bulletColor);e.pos.copy(this.playerFlight.pos),e.pos.x+=this.unit.pos.x,e.pos.y-=6,e.velocity.rotateAround(this.angle),this.playerFlight.manager.add(e),t.Audio.play(t.Audio.sounds.shoot)}}}class o extends i{constructor(t,s,i){super(t,s),this.clockwise=i,this.count=0,this.interval=e}makeBullet(){if(this.playerFlight.manager){const e=(this.count%2==0?1:-1)*this.clockwise,s=new t.FingerBeam(this.playerFlight,this.unit,e);s.pos.copy(this.playerFlight.pos),s.pos.x+=this.unit.pos.x,s.pos.y-=6,this.playerFlight.manager.add(s),this.count++,t.Audio.play(t.Audio.sounds.fingerLaser)}}}class r extends i{constructor(t,e,i){super(t,e),this.clockwise=i,this.count=0,this.interval=s}makeBullet(){if(this.playerFlight.manager){const e=(this.count%2==0?1:-1)*this.clockwise,s=new t.SquareBeam(this.playerFlight,this.unit);s.pos.copy(this.playerFlight.pos),s.pos.x+=this.unit.pos.x,s.pos.y-=6,s.velocity.rotateAround(-Math.PI/4*e),this.playerFlight.manager.add(s),this.count++,t.Audio.play(t.Audio.sounds.fingerLaser)}}}class n extends i{constructor(){super(...arguments),this.interval=1}makeBullet(){if(this.playerFlight.manager){const e=new t.BigLaser(this.playerFlight,this.unit);e.pos.copy(this.playerFlight.pos),e.pos.x+=this.unit.pos.x,this.playerFlight.manager.add(e),t.Audio.play(t.Audio.sounds.eyeLaser)}}}t.PlayerPoweredShot=class{constructor(){this.gun=new WeakMap}update(e,s){for(let i of s.flightUnits){const a=this.gun.get(i);a&&(a.update(e),t.Input.shared.fire&&s.canShoot&&a.shot())}}assignGun(t){for(let e=0;e<t.flightUnits.length;e++){const s=t.flightUnits[e];s.powered=!1,this.gun.set(s,new a(t,s,0))}if(t.flightUnits.length>=3){let e;switch(t.flightUnits.length){case 3:e=[0,2];break;case 4:e=[0,3];break;case 5:e=[0,4];break;case 6:e=[0,5];break;default:e=[1,t.flightUnits.length-2]}let s=0;for(let i of e){const e=t.flightUnits[i];this.gun.set(e,new a(t,e,s++?10*Math.PI/180:-10*Math.PI/180))}}if(t.flightUnits.length>=5){let e;switch(t.flightUnits.length){case 5:e=[1,3];break;case 6:e=[1,4];break;default:e=[2,t.flightUnits.length-3]}let s=0;for(let i of e){const e=t.flightUnits[i];this.gun.set(e,new o(t,e,s++?-1:1))}}if(t.flightUnits.length>=7)for(let e of[0,t.flightUnits.length-1]){const s=t.flightUnits[e];s.powered=!0,this.gun.set(s,new r(t,s,0==e?1:-1))}if(t.flightUnits.length>=9){const e=t.flightUnits[Math.floor(t.flightUnits.length/2)];this.gun.set(e,new n(t,e))}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=["ABCDEFG","HIJKLMN","OPQRSTU","VWXYZ "];t.PostScorePanel=class extends t.GameObject{constructor(){super(),this.initial=["_","_","_"],this.inputIndex=0,this.selectedIndex=0,this.pressed={left:!1,right:!1,fire:!1},this.time=0,this.renderHalf=!1}update(s){super.update(s),this.time+=s;const i=e.reduce((t,e)=>t+e.length,0);if(t.Input.shared.left?this.pressed.left||(this.pressed.left=!0,this.selectedIndex=(this.selectedIndex+i-1)%i,this.selectedIndex==i-2&&this.selectedIndex--):this.pressed.left=!1,t.Input.shared.right?this.pressed.right||(this.pressed.right=!0,this.selectedIndex=(this.selectedIndex+1)%i,this.selectedIndex==i-2&&this.selectedIndex++):this.pressed.right=!1,t.Input.shared.fire){if(!this.pressed.fire){this.pressed.fire=!0;const t=e.join("")[this.selectedIndex];if(t)switch(t){case void 0:case" ":break;case"":this.inputIndex>0&&this.inputIndex<this.initial.length&&(this.inputIndex-=1);break;default:this.inputIndex<this.initial.length&&(this.initial[this.inputIndex]=t,this.inputIndex++)}}}else this.pressed.fire=!1}render(s,i){super.render(s,i),i.save(),i.translate(0,-50),t.TextDrawer.shared.drawTextCenteredOutline("ENTER YOU INITIAL:",0,0,i),i.scale(2,2);const a=Array.from(this.initial);Math.floor(this.time/.1)%2==0&&this.inputIndex<a.length&&(a[this.inputIndex]=" "),t.TextDrawer.shared.drawTextCenteredOutline(a.join(),0,7,i),i.translate(-29,0);let o=0;for(let s=0;s<e.length;s++){const a=e[s];for(let e=0;e<a.length;e++)this.selectedIndex==o&&Math.floor(this.time/.1)%2!=0||t.TextDrawer.shared.drawTextCenteredOutline(a[e],10*e,21+7*s,i),o++}i.restore()}async postScore(e,s,i){let a=!1;try{const s=await t.Leaderboard.shared.getRecords();a=s.length<8||e.score>=s[7].score}catch(e){t.ErrorHandler.handle(e)}if(a){for(i.paused=!0;this.inputIndex<this.initial.length;)await this.wait(0);i.paused=!1;try{const i=this.initial.join("");await t.Leaderboard.shared.post(i,e.score,s,(o=(new Date).getTime(),r="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random();return o>0?(e=(o+e)%16|0,o=Math.floor(o/16)):(e=(r+e)%16|0,r=Math.floor(r/16)),("x"===t?e:3&e|8).toString(16)})))}catch(e){t.ErrorHandler.handle(e)}finally{this.removeFromManager()}}else this.removeFromManager();var o,r}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=20,a=new t.ColliderBox(new t.Vector2(9,9));t.PowerUp=class extends t.SpriteObject{constructor(e,s){super(t.Sprites.shared.images.powerup),this.scorer=e,this.nextMember=s,this.time=0}update(t){super.update(t),this.time+=t,this.pos.y+=i*t,this.pos.y>=this.scorer.stage.bottom+4.5?this.removeFromManager():this.collidePlayer()}collidePlayer(){if(this.manager)for(let i of this.manager.playerFlights)if(i.visible)for(let o of i.flightUnits)if(t.CollisionChecker.intersect(a,this.pos,o.collisionShape,e.add(i.pos,o.pos),s)){const e=this.nextMember();if(e)i.add([e]);else{this.scorer.score+=1e3;const e=new t.FloatingText("1000");e.pos.copy(s),this.manager.add(e)}t.Audio.play(t.Audio.sounds.bonus),this.removeFromManager();break}}render(t,e){e.filter=`brightness(${Math.floor(400*Math.cos(2*Math.PI*this.time/.5))}%)`,e.drawImage(this.sprite,Math.floor(this.pos.x-this.sprite.width/2)+1,Math.floor(this.pos.y-this.sprite.height/2)),e.drawImage(this.sprite,Math.floor(this.pos.x-this.sprite.width/2)-1,Math.floor(this.pos.y-this.sprite.height/2)),e.drawImage(this.sprite,Math.floor(this.pos.x-this.sprite.width/2),Math.floor(this.pos.y-this.sprite.height/2)+1),e.drawImage(this.sprite,Math.floor(this.pos.x-this.sprite.width/2),Math.floor(this.pos.y-this.sprite.height/2)-1),e.filter="none",super.render(t,e)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){function e(t,e){let s=`${t}`;for(;s.length<e;)s="0"+s;return s}t.addLeadingZero=e;const s="hiscore";t.highestScoreDisplay=999999;t.ScoreAndCredit=class extends t.GameObject{constructor(t,e){super(),this.stage=t,this.franchouchou=e,this._score=0,this._hiScore=parseInt(localStorage.getItem(s)||"0"),this.credit=0,this.nextCredit=1e4,this.renderOrder=1,this.renderHalf=!1}get score(){return this._score}set score(e){this._score=e,this.updateHiScore(e),this._score>this.nextCredit&&(this.credit+=1,t.Audio.play(t.Audio.sounds.credit),this.nextCredit+=1e4)}get hiScore(){return this._hiScore}updateHiScore(t){t>this.hiScore&&(this._hiScore=t,localStorage.setItem(s,`${this._hiScore}`))}render(s,i){super.render(s,i);const a=this.stage.right-this.stage.left,o=this.stage.bottom-this.stage.top;t.TextDrawer.shared.drawText(`SCORE ${e(Math.min(t.highestScoreDisplay,this.score),6)}`,Math.floor(-a/2+4),Math.floor(-o/2+9),i);const r=`HI-SCORE ${e(Math.min(t.highestScoreDisplay,this.hiScore),6)}`;t.TextDrawer.shared.drawText(r,Math.floor(a/2-2-t.TextDrawer.shared.measure(r)),Math.floor(-o/2+9),i);const n=`CREDIT ${e(Math.min(this.credit,99),2)}`;t.TextDrawer.shared.drawText(n,Math.floor(a/2-2-t.TextDrawer.shared.measure(n)),Math.floor(o/2-10),i),t.TextDrawer.shared.drawText(`${this.franchouchou.remainingMember}`,Math.floor(-a/2+4),Math.floor(o/2-10),i)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=new t.Vector2,i=400,a=new t.ColliderCompoundShape;t.SquareBeam=class extends t.PlayerBullet{constructor(e,s){if(super(e.stage,s.bulletColor),this.target=new t.Vector2,this.turnAllowance=1,this.path=[],this.decay=!1,this.drawLength=i,this.prevSign=0,this.velocity.normalize().multiply(i),e.manager){const t=Array.from(e.manager.enemyFlights);t.length>0&&this.target.copy(t[Math.floor(Math.random()*t.length)].pos)}}setDrawLength(){this.drawLength=0;for(let t=this.path.length-1;t>0;t--)this.drawLength+=this.path[t].distance(this.path[t-1])}offscreenCheck(){(this.pos.y<=this.stage.top||this.pos.y>=this.stage.bottom)&&(this.decay=!0,this.drawLength=0,this.setDrawLength())}onHitEnemy(t){this.spark(t),this.collisionShape=a}update(t){if(super.update(t),0==this.path.length&&(this.path.push(this.pos.clone()),this.path.push(this.pos.clone())),this.path[this.path.length-1].copy(this.pos),this.turnAllowance>0){const t=Math.sign(e.sub(this.target,this.pos).normalize().dot(this.velocity));if(0!=this.prevSign&&t!=this.prevSign){const t=e.angle(s.copy(this.velocity).normalize());this.velocity.rotateAround(t>0?Math.PI/2:-Math.PI/2),this.turnAllowance--,this.path.push(this.pos.clone())}this.prevSign=t}this.decay&&(this.drawLength-=t*i);let a=0;for(let t=this.path.length-1;t>0;t--)if((a+=this.path[t].distance(this.path[t-1]))>this.drawLength){this.path[t-1].add(e.sub(this.path[t],this.path[t-1]).normalize().multiply(a-this.drawLength)),this.path.splice(0,t-1);break}this.drawLength<=0&&this.removeFromManager()}render(e,s){s.fillStyle=this.color;for(let e=0;e<this.path.length-1;e++)t.drawLine(this.path[e],this.path[e+1],2,s);s.fillStyle="white";for(let e=0;e<this.path.length-1;e++)t.drawLine(this.path[e],this.path[e+1],1,s)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=.0025;function s(t){return new Promise(e=>{setTimeout(e,1e3*t)})}class i{constructor(t,e,s){this.h=t,this.s=e,this.l=s,this.setSeq=0}async set(e,i,a,o){const r=++this.setSeq;let n=this.h;const h=this.s,l=this.l,c=e-n;c>180?e-=360:c<-180&&(n-=360);let d=0;for(;d<o&&r==this.setSeq;){await s(.1),d+=.1;const r=Math.min(1,d/o);this.h=t.mix(n,e,r),this.h<0&&(this.h+=360),this.s=t.mix(h,i,r),this.l=t.mix(l,a,r)}}get style(){return`hsl(${Math.floor(this.h)},${Math.floor(this.s)}%,${Math.floor(this.l)}%)`}}const a=[t.Sprites.shared.images.cloud0,t.Sprites.shared.images.cloud1,t.Sprites.shared.images.cloud2,t.Sprites.shared.images.cloud3];class o extends t.SpriteObject{constructor(){super(a[Math.floor(4*Math.random())]),this.velocity=new t.Vector2,this.time=0,this.velocity.set(0,100+200*Math.random())}update(t){super.update(t),this.time+=t,this.pos.addScaled(this.velocity,t),this.time>=5&&this.removeFromManager()}}t.StarNight=class extends t.GameObject{constructor(s){super(),this.stage=s,this.isStarNight=!0,this._state="battle",this.bgColor=new i(346,30,8),this.renderOrder=-1;const a=s.right-s.left,o=s.bottom-s.top;this.stars=new Array(Math.floor(a*o*e));for(let e=0;e<this.stars.length;e++)this.stars[e]={color:new i(343,67,27),pos:new t.Vector2(s.left+Math.random()*a,s.top+Math.random()*o),speed:.6*(10+10*Math.random()),height:1}}get state(){return this._state}set state(t){this._state=t,this.onStateChanged()}update(t){super.update(t);const e=this.stage.bottom-this.stage.top;for(let s of this.stars)s.pos.y+=s.speed*t,s.pos.y>this.stage.bottom&&(s.pos.y-=e)}render(t,e){super.render(t,e);const s=e.canvas.width,i=e.canvas.height;e.fillStyle=this.bgColor.style,e.fillRect(-s/2,-i/2,s,i);for(let t of this.stars)e.fillStyle=t.color.style,e.fillRect(Math.floor(t.pos.x),Math.floor(t.pos.y),1,t.height)}onStateChanged(){switch(this.state){case"starSky":this.bgColor.set(this.bgColor.h,this.bgColor.s,0,5);for(let t of this.stars)t.color.set(Math.floor(360*Math.random()),t.color.s,Math.floor(27+73*Math.random()),5);break;case"burning":this.bgColor.set(4,89,46,2);for(let t of this.stars)t.color.set(55,73,50,2),t.speed*=20;break;case"whiteout":this.bgColor.set(4,89,100,.3);for(let t of this.stars)t.color.set(55,73,100,.3);break;case"bluesky":this.bgColor.set(214,67,42,2);for(let t of this.stars)t.color.set(211,72,48,2),t.height=3;if(this.manager)for(let t=0;t<50;t++){const t=new o;t.pos.set(this.stage.left+Math.random()*(this.stage.right-this.stage.left),this.stage.bottom-Math.random()*(this.stage.bottom-this.stage.top+100)),this.manager.add(t)}}}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.StartScreen=class extends t.GameObject{constructor(e,s){super(),this.onStart=s,this.time=0,this.leaderboard=new t.LeaderboardScreen(e),this.renderOrder=1,this.renderHalf=!1}update(e){super.update(e),this.time+=e,t.Input.shared.pressAnyKey&&this.time>=1&&(this.onStart(),this.removeFromManager(),this.leaderboard.removeFromManager())}render(e,s){super.render(e,s);const i="PRESS ANY KEY TO START";t.TextDrawer.shared.drawText(i,Math.floor(-t.TextDrawer.shared.measure(i)/2),30,s)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=12,s=9,i=10,a={};for(let t=0;t<10;t++)a[`${t}`]={x:26+t*e,y:46};for(let t=0;t<"ABCDEFGHIJKLMNO".length;t++)a["ABCDEFGHIJKLMNO"[t]]={x:38+t*e,y:55};for(let t=0;t<"PQRSTUVWXYZ".length;t++)a["PQRSTUVWXYZ"[t]]={x:26+t*e,y:64};a["."]={x:26+14*e,y:36},a._={x:98,y:28},a[""]={x:158,y:28},a["-"]={x:182,y:37},a["?"]={x:206,y:46},a[""]={x:182,y:154},a[""]={x:194,y:154},a[""]={x:206,y:154};class o{constructor(){this.fontSheet=t.Sprites.shared.images.font}initOutline(){if(!this.outlineFontSheet){this.outlineFontSheet=document.createElement("canvas"),this.outlineFontSheet.width=this.fontSheet.width,this.outlineFontSheet.height=this.fontSheet.height;const t=this.outlineFontSheet.getContext("2d");t.translate(1,1),t.drawImage(this.fontSheet,1,0),t.drawImage(this.fontSheet,0,1),t.drawImage(this.fontSheet,-1,0),t.drawImage(this.fontSheet,0,-1),t.drawImage(this.fontSheet,1,1),t.drawImage(this.fontSheet,-1,-1),t.drawImage(this.fontSheet,1,-1),t.drawImage(this.fontSheet,-1,1),t.fillStyle="black",t.globalCompositeOperation="source-in",t.fillRect(0,0,this.outlineFontSheet.width,this.outlineFontSheet.height),t.globalCompositeOperation="source-over",t.drawImage(this.fontSheet,0,0)}}measure(t){return t.length*i*.5}drawText(t,e,s,i){this._drawText(t,e,s,i,this.fontSheet)}drawTextOutline(t,e,s,i){this.initOutline(),this._drawText(t,e,s,i,this.outlineFontSheet)}drawTextCenteredOutline(t,e,s,i){this.initOutline(),this._drawText(t,e-this.measure(t)/2,s,i,this.outlineFontSheet)}_drawText(t,o,r,n,h){n.save(),n.translate(o,r),n.scale(.5,.5);for(let o of t){const t=a[o];t&&n.drawImage(h,t.x,t.y,e,s,0,0,e,s),n.translate(i,0)}n.restore()}}o.shared=new o,t.TextDrawer=o}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.Vector2,s=1e3,i=1e-4,a=new t.ColliderBox(new t.Vector2(250,250)),o=Math.PI/16;class r extends t.EnemyFlight{constructor(e){super(t.Sprites.shared.images.ufo,e,1e4,s),this.collisionShape=a,this.rotateStep=1e-4}resetRotation(t){}async turn(t,e){for(;Math.abs(this.rotate-t)>i;){const s=await this.wait(0),i=t-this.rotate;this.rotate+=Math.sign(i)*Math.min(Math.abs(i),e*s)}}wrapAround(){}playExplosionAnimation(){if(this.manager){const e=new t.BloodStainOverAnyWhere;e.pos.copy(this.pos),this.manager.add(e),e.drop(180,4)}}async playAttackSequence(){const e=new t.Vector2,s=this.scorer.stage;await t.ObjectMotionControl.moveTo(this,e.set(0,s.top-60),10),await this.wait(2),await Promise.all([this.startAttack()])}async startAttack(){for(this.attackPhase1().catch(t=>{});this.hp>3*s/4;)await this.wait(0);for(this.terminateAllWaiting(),this.attackPhase2().catch(t=>{});this.hp>2*s/4;)await this.wait(0);for(this.terminateAllWaiting(),this.attackPhase3().catch(t=>{});this.hp>s/4;)await this.wait(0);for(this.terminateAllWaiting(),this.attackPhase4().catch(t=>{});this.hp>0;)await this.wait(0)}async normalShot(e,s=.5,i=30,a=3,o=.4){const r=t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(o),new t.RingNode(new t.ConstantNode(5),new t.ConstantNode(16),new t.EnemyBulletNode(new t.ConstantNode(e),new t.SineNode(new t.ConstantNode(s),new t.ConstantNode(Math.PI/6)),new t.ConstantNode(i)))));try{await this.wait(a)}catch(t){throw t}finally{r.stop()}}shootLaser(e){if(this.manager){const s=new l(this,-this.rotate+e);this.manager.add(s),t.Audio.play(t.Audio.sounds.eyeLaser)}}async rotatingShootLaser(t){await Promise.all([this.turn(this.rotate+Math.PI/2*t,Math.PI/5),(async()=>{for(let e=0;e<6;e++)e%2==0?this.shootLaser(-10*Math.PI/180*t):this.shootLaser(-40*Math.PI/180*t),await this.wait(.3)})()])}async attackPhase1(){const e=new t.Vector2,s=new t.Vector2,i=new t.Vector2;await this.normalShot(e.set(0,150).rotateAround(15*Math.PI/180)),await this.wait(1),await this.normalShot(e.set(0,150).rotateAround(-15*Math.PI/180)),await this.wait(1),await this.normalShot(e.set(0,150)),await this.wait(1);for(let t=0;;t++)await Promise.all([this.normalShot(e.set(0,150).rotateAround(15*Math.PI/180)),this.normalShot(s.set(0,150).rotateAround(-15*Math.PI/180))]),await this.wait(1),await Promise.all([this.normalShot(e.set(0,150).rotateAround(0)),this.normalShot(s.set(0,150).rotateAround(-15*Math.PI/180))]),await this.wait(1),await Promise.all([this.normalShot(e.set(0,150).rotateAround(0)),this.normalShot(s.set(0,150).rotateAround(15*Math.PI/180))]),await this.wait(1),await Promise.all([this.normalShot(e.set(0,150).rotateAround(0)),this.normalShot(s.set(0,150).rotateAround(15*Math.PI/180)),this.normalShot(i.set(0,150).rotateAround(-15*Math.PI/180))]),await this.wait(1)}async attackPhase2(){for(await this.turn(Math.PI/5,o),this.shootLaser(0),await this.wait(2),this.shootLaser(15*Math.PI/180),await this.wait(2),this.shootLaser(-15*Math.PI/180),await this.wait(2);;){for(let e=0;e<2;e++){const s=e%2==0?1:-1;for(let e=0;e<6;e++)this.shootLaser(t.mix(-30*Math.PI/180,30*Math.PI/180,e/6)*s),await this.wait(.5);await this.wait(2)}for(let e=0;e<8;e++){const s=e%2==0?1:-1;this.shootLaser(t.mix(30*Math.PI/180,0,e/8)*s),await this.wait(.5)}await this.wait(2)}}async attackPhase3(){const e=new t.Vector2,s=new t.Vector2,i=new t.Vector2;await this.turn(2*Math.PI/5,o);for(let t=0;;t++){for(let e=0;e<2;e++)await this.rotatingShootLaser((e+t)%2==0?1:-1),await this.wait(1);await Promise.all([this.normalShot(e.set(0,150).rotateAround(0),10,50,6,.3),this.normalShot(s.set(0,150).rotateAround(15*Math.PI/180),10,50,6,.3),this.normalShot(i.set(0,150).rotateAround(-15*Math.PI/180),10,50,6,.3)]),await this.wait(1)}}async attackPhase4(){const e=new t.Vector2,s=new t.Vector2;await this.turn(this.rotate+Math.PI/5,o),await this.wait(2);for(let i=0;;i++){for(let i=0;i<2;i++){const a=i%2==0?1:-1;await Promise.all([(async()=>{for(let e=0;e<6;e++)this.shootLaser(t.mix(-30*Math.PI/180,30*Math.PI/180,e/6)*a),await this.wait(.5)})(),this.normalShot(e.set(0,150).rotateAround(0)),this.normalShot(s.set(0,150).rotateAround(15*a*Math.PI/180))]),await this.wait(2)}await Promise.all([(async()=>{for(let e=0;e<8;e++){const s=e%2==0?1:-1;this.shootLaser(t.mix(30*Math.PI/180,0,i%2==0?e/8:1-e/8)*s),await this.wait(.5)}})(),this.normalShot(e.set(0,150).rotateAround(15*Math.PI/180)),this.normalShot(s.set(0,150).rotateAround(-15*Math.PI/180))]),await this.wait(2)}}}const n=new t.ColliderCompoundShape,h=new t.ColliderBox(new t.Vector2(6,223));class l extends t.EnemyBullet{constructor(s,i){super(s.scorer.stage,e.set(0,1),s,0),this.angle=i,this.cooldown=0,this.collisionShape=n,this.anchorPos(),this.animation=new t.AnimatedSpriteObject([t.Sprites.shared.images.blaser0,t.Sprites.shared.images.blaser1,t.Sprites.shared.images.blaser2,t.Sprites.shared.images.blaser3,t.Sprites.shared.images.blaser4,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser5,t.Sprites.shared.images.blaser6,t.Sprites.shared.images.blaser7,t.Sprites.shared.images.blaser8],.05),this.animation.pos=this.pos,this.animation.removeFromManager=(()=>{this.removeFromManager()})}anchorPos(){this.pos.set(0,180).rotateAround(this.angle+this.shooter.rotate).add(this.shooter.pos)}offscreenCheck(){}onHitPlayer(){}update(t){super.update(t),this.animation.update(t),this.anchorPos(),this.cooldown-=t,this.animation.frame>=5&&this.animation.frame<17&&this.cooldown<=0?this.collisionShape=h:this.collisionShape=n}render(t,e){e.save(),e.translate(-4,0),e.translate(Math.floor(this.pos.x),Math.floor(this.pos.y)),e.rotate(Math.PI),e.translate(Math.floor(-this.pos.x),Math.floor(-this.pos.y)),this.animation.render(t,e),e.restore()}}t.UFOWave=class extends t.BossEnemyWave{constructor(t,e,s){super(s),this.stage=t,this.onWaveEnd=e}async ufoFlyOver(e){const s=new t.Vector2,i=new t.VideoNoise;i.renderHalf=!1,i.renderOrder=3,i.strength=0,e.add(i);const a=new t.SpriteObject(t.Sprites.shared.images.ufo);a.renderHalf=!1,a.renderOrder=2,a.pos.set(0,this.stage.bottom+200),e.add(a),await Promise.all([t.ObjectMotionControl.moveTo(a,s.set(0,this.stage.top-200),50),(async()=>{t.Audio.play(t.Audio.sounds.alienShip);const e=this.stage.bottom+200;for(;Math.abs(a.pos.y-(this.stage.top-200))>1;)await i.wait(0),i.strength=1-Math.abs(a.pos.y/e)})()]),a.removeFromManager(),i.removeFromManager()}async showTitle(t,e){await this.ufoFlyOver(t),await super.showTitle(t,e)}init(e,s,i){const a=new t.GameObject;s.add(a);const o=new r(e);o.pos.set(0,e.stage.top-180),this.enemies.push(o),s.add(o);const n=this.dropPowerUp(e,s);o.playAttackSequence().then(async()=>{n.stop(),await a.wait(5),a.removeFromManager(),this.onWaveEnd()})}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.VideoNoise=class extends t.GameObject{constructor(){super(...arguments),this.time=0,this.strength=1}update(t){super.update(t),this.time+=t}render(t,e){const s=document.createElement("canvas"),i=1/(1+7*this.strength);s.width=Math.floor(e.canvas.width*i),s.height=Math.floor(e.canvas.height*i);const a=s.getContext("2d");a.imageSmoothingEnabled=!1,a.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height,0,0,s.width,s.height),e.save(),e.resetTransform(),e.filter=`saturate(${Math.floor(100*(1-this.strength))}%) hue-rotate(${Math.floor(180*this.strength)}deg) contrast(${Math.floor(100*(1+this.strength))}%)`,e.drawImage(s,0,0,s.width,s.height,0,0,e.canvas.width,e.canvas.height),e.restore()}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.WaveManager=class{set pause(t){this.enemyWave&&(this.enemyWave.pause=t)}async showTitle(t,e){await(this.enemyWave&&this.enemyWave.showTitle(t,e))}init(e,s,i,a,o,r,n){switch(this.enemyWave&&this.enemyWave.clear(),e){case 9:t.Audio.playBgm("./bgm/Zombieland Saga OP 8bit cover.mp3"),this.enemyWave=new t.Zombie3Wave(r,o);break;case 19:t.Audio.playBgm("./bgm/   REVENGE Zombieland Saga Revenge 8bit.mp3"),this.enemyWave=new t.KaijinWave(r,o);break;case 29:t.Audio.playBgm("./bgm/Yomigaere 8bit.mp3"),this.enemyWave=new t.UFOWave(s.stage,r,o);break;case 30:t.Audio.playBgm("./bgm/Zombieland Saga Revenge OP  Taiga yo Tomo ni Naite Kure 8bitNES style.mp3"),this.enemyWave=new t.EndingWave(n);break;default:this.enemyWave=new t.EnemyWave(s.stage,e,r)}this.enemyWave.init(s,i,a)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){t.WaveScreen=class extends t.GameObject{constructor(t,e){super(),this.wave=t,this.onEnd=e,this.time=0,this.renderOrder=1,this.renderHalf=!1}update(t){super.update(t),this.time+=t,this.time>=3&&(this.onEnd(),this.removeFromManager())}render(e,s){super.render(e,s);const i=`WAVE ${t.addLeadingZero(this.wave,2)}`;t.TextDrawer.shared.drawText(i,Math.floor(-t.TextDrawer.shared.measure(i)/2),30,s)}}}(zlsSpaceInvader||(zlsSpaceInvader={})),function(t){const e=new t.ColliderCompoundShape;e.shapes.push({shape:new t.ColliderBox(new t.Vector2(20,71)),pos:new t.Vector2(0,9)}),e.shapes.push({shape:new t.ColliderBox(new t.Vector2(39,26)),pos:new t.Vector2(0,-13)});const s=500,i=.2,a=1e4;class o extends t.EnemyFlight{constructor(i,o=s,r=a/2){super(t.Sprites.shared.images.bigZombie,i,r,o),this.collisionShape=e}wrapAround(){}playExplosionAnimation(){if(this.manager){const e=new t.BloodStainOverAnyWhere;e.pos.copy(this.pos),this.manager.add(e),e.drop(80)}}async playAttackSequence(e){const s=new t.Vector2;try{await t.ObjectMotionControl.moveTo(this,s.set(0,-30),50),await this.wait(3),await Promise.all([this.phase1(),this.phase2(e)])}catch(t){}}async phase1(){const e=this.scorer.stage,s=new t.Vector2;let i;try{for(let a=0;;a++)i&&i.stop(),i=t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.3),new t.RingNode(new t.ConstantNode(5),new t.ConstantNode(16),new t.EnemyBulletNode(new t.ConstantNode(new t.Vector2(0,-33)),void 0,new t.ConstantNode(60))))),await t.ObjectMotionControl.moveTo(this,s.set(e.left+20,this.pos.y),20),await this.wait(.5),await t.ObjectMotionControl.moveTo(this,s.set(e.right-20,this.pos.y),20),await this.wait(.5),i.stop(),i=void 0,await t.ObjectMotionControl.moveTo(this,s.set(0,this.pos.y),20),await this.wait(3),i=t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.4),new t.RingNode(new t.ConstantNode(5),new t.ConstantNode(16),new t.EnemyBulletNode(new t.ConstantNode(new t.Vector2(0,-33)),new t.SineNode(new t.ConstantNode(.5),new t.ConstantNode(Math.PI/6)),new t.ConstantNode(30))))),await t.ObjectMotionControl.moveCircle(this,s.set(0,0),50,30*a*Math.PI/180,a%2==0,20),await this.wait(3)}catch(t){}finally{i&&i.stop()}}async phase2(e){const r=new t.Vector2;for(;this.hp>s*i;)await this.wait(0,1);this.terminateAllWaiting(),await this.wait(2),await t.ObjectMotionControl.moveTo(this,r.set(0,-30),50),await this.wait(1),this.renderOrder+=.1;const n=await Promise.all([0,1].map(async r=>{const n=new o(this.scorer,s*i,a/4);n.pos.copy(this.pos),this.manager&&this.manager.add(n),e.push(n);try{await t.ObjectMotionControl.moveTo(n,new t.Vector2(this.pos.x+30*(0==r?1:-1),this.pos.y),10)}catch(t){}return n}));n.push(this);try{await this.wait(1)}catch(t){}await Promise.all(n.map(async(t,e)=>{try{await t.wait(1*e),await t.phase2_2()}catch(t){}}))}async phase2_2(){const e=new t.Vector2,s=t.FlightShootPatternControl.shoot(this,new t.IntervalNode(new t.ConstantNode(.4),new t.RingNode(new t.ConstantNode(5),new t.ConstantNode(16),new t.EnemyBulletNode(new t.ConstantNode(new t.Vector2(0,-33)),new t.SineNode(new t.ConstantNode(.5),new t.ConstantNode(Math.PI/6)),new t.ConstantNode(30)))));try{for(let s=0;;s++)await t.ObjectMotionControl.moveCircle(this,e.set(50*Math.sin(s*Math.PI*2/20),-30),20,0,!0,60)}catch(t){}finally{s.stop()}}}t.Zombie3Wave=class extends t.BossEnemyWave{constructor(t,e){super(e),this.onWaveEnd=t}init(e,s,i){const a=new t.GameObject;s.add(a);const r=new o(e);r.pos.set(0,e.stage.top-40),this.enemies.push(r),s.add(r);const n=this.dropPowerUp(e,s);r.playAttackSequence(this.enemies).then(async()=>{n.stop(),await a.wait(5),a.removeFromManager(),this.onWaveEnd()})}}}(zlsSpaceInvader||(zlsSpaceInvader={}));